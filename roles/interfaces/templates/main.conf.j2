#jinja2:lstrip_blocks: True
{# role 'interfaces' in Playbook einbauen, um diesen Teil der config zu generieren 
#}
{% import 'helpers/macros.j2' as macros with context %}
{% set vlans_merged = ({}) %}
{{ macros.merge_vlans(group.vlans, vlans_merged) }}
interfaces {
{% for _ifrange_ in if_ranges|sort %}
    {% set ifrange = if_ranges[_ifrange_] %}
    interface-range {{ _ifrange_ }} {
    {% if ifrange.member_ranges is defined %}
        {% for rng in ifrange.member_ranges %}
        member-range {{ rng }};
        {% endfor %}
    {% endif %}
    {% if ifrange.member_range is defined %}
        member-range {{ ifrange.member_range }};
    {% endif %}
    {% if ifrange.members is defined %}
        {% for intf in ifrange.members %}
        member {{ intf }};
        {% endfor %}
    {% endif %}
    {% if ifrange.member is defined %}
        member {{ ifrange.member }};
    {% endif %}
    {% if (ifrange.mode is defined or ifrange.vlan is defined or ifrange.vlans is defined) %}
        unit 0 {
            family ethernet-switching {
            {% if ifrange.mode is defined %}
                port-mode {{ ifrange.mode }};
            {% endif %}
            {% if ifrange.vlan is defined %}
                vlan {
                    members {% if ifrange.vlan == 'all' %}all{% else %}{{ vlans_merged[ifrange.vlan] }}{% endif %};
                }
            {% elif ifrange.vlans is defined %}
                vlan {
                    members [ {% for vln in ifrange.vlans %}{{ vlans_merged[vln] }} {% endfor %}];
                }
            {% endif %}
            {% if ifrange.native is defined %}
                native-vlan-id {{ ifrange.native }};
            {% endif %}
            }
        }
    {% endif %}
    }
{% endfor %}
{% for _iface in interfaces %}
    {% set iface = interfaces[_iface] %}
    {{ _iface }} {
    {% if iface.desc is defined %}
        description "{{ iface.desc }}";
    {% endif %}
    {% if iface.mtu is defined %}
        mtu {{ iface.mtu }};
    {% endif %}
    {% if iface.etheroptions is defined %}
        ether-options {
        {% if iface.etheroptions.no_auto == true %}
            no-auto-negotiation;
        {% endif %}
        {% if iface.etheroptions.half_duplex == true %}
            link-mode full-duplex;
        {% endif %}
        {% if iface.etheroptions.speed is defined %}
            speed {
                {{ iface.etheroptions.speed }};
            }
        {% endif %}
        }
    {% endif %}
    {% if (iface.vlan is defined or iface.vlans is defined) %}
        unit 0 {
            family ethernet-switching {
            {% if iface.mode is defined %}
                port-mode {{ iface.mode }};
            {% endif %}
            {% if iface.vlan is defined %}
                vlan {
                    members {% if iface.vlan == 'all' %}all{% else %}{{ vlans_merged[iface.vlan] }}{% endif %};
                }
            {% elif iface.vlans is defined %}
                vlan {
                    members [ {% for vln in iface.vlans %}{{ vlans_merged[vln] }} {% endfor %}];
                }
            {% endif %}
            {% if iface.native is defined %}
                native-vlan-id {{ iface.native }};
            {% endif %}
            }
        }
    {% endif %}
    }
{% endfor %}
    me0 {
        unit 0 {
            description "{{ inventory_hostname }} local OOB Mgmt";
            family inet {
                address 169.254.1.1/16;
            }
            family inet6;
        }
    }
    vlan {
        unit {{ group.mgmt.vlan }} {
            description "{{ inventory_hostname }} Mgmt";
            family inet {
                address {{ host.mgmt.v4_addr }}/24;
            }
            family inet6 {
                address {{ host.mgmt.v6_addr }}/64;
            }
        }
    }
}